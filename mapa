#include <stdlib.h>
#include <stdio.h>
#include <math.h>

#define vertice int
#define NUM_CIDADES 400

struct mapa{
    int V;
    int A;
    float **adj;
};

typedef struct cidade{
    int id;
    float x;
    float y;
}cidade;

typedef struct mapa *Mapa;

Mapa iniciarMapa( int cidades);
static float **AddMatrix( int r, int c, int val);
void AddDistancia(Mapa m, cidade o, cidade c);
void acharPercurso(Mapa m);
int VizinhoProximo(Mapa m , int ini, int *fim);

float totalDist(Mapa m, int *fim);
float dist(Mapa m, int a, int b);

int main(){

    Mapa m = iniciarMapa(NUM_CIDADES);
    
    FILE* file;

    file = fopen("cidades.tsp","r");

    float buffer;
    char linha[256];
    int cord = 0;
    int cont =0;

    cidade *mun = (cidade *)malloc(NUM_CIDADES * sizeof(cidade));
    
    while(fgets(linha,256,file)!=EOF){
        
        if (strstr(linha, "NODE_COORD_SECTION")) {
            cord = 1;
            continue;
        }

        if (cord == 1){
            float xm,ym;
            int id_lido;

            if (sscanf(linha, "%d %lf %lf", &id_lido, &xm, &ym) == 3){
                mun[cont].id = id_lido - 1;
                mun[cont].x = xm;
                mun[cont].y = ym;
                cont++;

            }
        }
    }
    fclose(file);

    for(int i = 0; i < NUM_CIDADES; i++){
        for(int j = i+1; j < NUM_CIDADES; j++){
            AddDistancia(m, mun[i], mun[j]);
        }
    }

    acharPercurso(m);

}

Mapa iniciarMapa ( int cidade){
    Mapa C = malloc(sizeof *C);
    C->V = cidade;
    C->A = 0;
    C->adj = AddMatrix(cidade,cidade,0);
    return C;
}

static float **AddMatrix( int r, int c, int val) { 
   int **m = malloc( r * sizeof (int *));
   for (vertice i = 0; i < r; ++i) 
      m[i] = malloc( c * sizeof (int));
   for (vertice i = 0; i < r; ++i)
      for (vertice j = 0; j < c; ++j)
         m[i][j] = val;
   return m;
}

void AddDistancia(Mapa m,cidade o, cidade c){

    if( m->adj[o.id][c.id] == 0){
        float xo = o.x;
        float yo = o.y;

        float xc = c.x;
        float yc = c.y;

        float d = sqrt(pow(xo-xc, 2) + pow(yo-yc, 2));

        m->adj[o.id][c.id] = d;
        m->adj[c.id][o.id] = d;
        m->A++;
    }

}

void acharPercurso(Mapa m){
    int *caminho = malloc(m->V * sizeof(int));

    VizinhoProximo(m, 0, caminho);

    printf("Percurso final:\n");
    for (int i = 0; i < m->V; i++)
        printf("%d ", caminho[i]);
    printf("\n");

    printf("DistÃ¢ncia total: %.3f\n", totalDist(m, caminho));
}

int VizinhoProximo(Mapa m , int ini, int *fim){    
    int visitado[m->V];
    for (int i = 0; i < m->V; i++) visitado[i] = 0;

    visitado[ini] = 1;
    fim[0] = ini;
    int atual = ini;

    for (int k = 1; k < m->V; k++) {
        float melhor = 1e30;
        int prox = -1;
        for (int j = 0; j < m->V; j++) {
            if (!visitado[j] && m->adj[atual][j] < melhor && atual != j) {
                melhor = m->adj[atual][j];
                prox = j;
            }
        }
        fim[k] = prox;
        visitado[prox] = 1;
        atual = prox;
    }
    return 0;
}

float dist(Mapa m, int a, int b) {
    return m->adj[a][b];
}

float totalDist(Mapa m, int *fim) {
    float s = 0;
    for (int i = 0; i < m->V - 1; i++)
        s += m->adj[fim[i]][fim[i+1]];
    s += m->adj[fim[m->V-1]][fim[0]];
    return s;
}
